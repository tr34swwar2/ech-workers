name: echs-workers-arm64 é…ç½®æ–‡ä»¶æ”¯æŒ

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release æ ‡ç­¾ (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
      target_os:
        description: 'ç›®æ ‡æ“ä½œç³»ç»Ÿ (GOOS)'
        required: true
        default: 'linux'
      target_arch:
        description: 'ç›®æ ‡æ¶æ„ (GOARCH)'
        required: true
        default: 'arm64'
      output_name:
        description: 'è¾“å‡ºæ–‡ä»¶å (ä¾‹å¦‚: ech-linux-arm64)'
        required: true
        default: 'ech-linux-arm64'

jobs:
  build_and_release:
    # æˆäºˆå·¥ä½œæµç¨‹æƒé™ä»¥åˆ›å»º/ä¿®æ”¹ Releases
    permissions:
      contents: write
      
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' 

      - name: âš™ï¸ äº¤å‰ç¼–è¯‘ ${{ github.event.inputs.output_name }}
        # å°†ç¼–è¯‘æ­¥éª¤æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„ run å—ä¸­
        run: |
          echo "GOOS: ${{ github.event.inputs.target_os }}"
          echo "GOARCH: ${{ github.event.inputs.target_arch }}"
          
          # è®¾ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡
          export GOOS=${{ github.event.inputs.target_os }}
          export GOARCH=${{ github.event.inputs.target_arch }}
          export CGO_ENABLED=0

          # ç¼–è¯‘ Go ç¨‹åºï¼Œä½¿ç”¨ -ldflags å‡å°ä½“ç§¯
          go build -ldflags "-s -w" -o ${{ github.event.inputs.output_name }} ./echs-workers.go
        
      - name: ğŸš€ åˆ›å»ºå¹¶ä¸Šä¼  Release Asset
        # softprops/action-gh-release å¯ä»¥ä¸€æ­¥å®Œæˆåˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v1
        with:
          # ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ tag ä½œä¸º Release æ ‡ç­¾
          tag_name: ${{ github.event.inputs.release_tag }}
          # è‡ªåŠ¨ç”Ÿæˆ Release åç§°
          name: Release ${{ github.event.inputs.release_tag }} (${{ github.event.inputs.target_os }}-${{ github.event.inputs.target_arch }})
          # åˆ›å»ºä¸€ä¸ªè‰ç¨¿ Releaseï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨æ£€æŸ¥åå†å‘å¸ƒ
          draft: true
          # æŒ‡å®šè¦ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„
          files: |
            ${{ github.event.inputs.output_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
